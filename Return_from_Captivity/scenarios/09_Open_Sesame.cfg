#textdomain wesnoth-Return_from_Captivity

[multiplayer]
    id=CSABI_Open_Sesame
    next_scenario=CSABI_The_Tunnel
    name= _"RfC-Open Sesame"
    map_data="{~add-ons/Return_from_Captivity/maps/09_Open_Sesame.map}"
    description= _"A multi player campaign for 2 cooperative players. Bring home the elves and dwarfs from the troll prison."
    turns="40"
    victory_when_enemies_defeated=no
    experience_modifier=100%
    allow_new_game=no
    random_start_time=no
    {DEFAULT_MUSIC_PLAYLIST}

    {SECOND_WATCH}
    {DAWN}
    {MORNING}
    {AFTERNOON}
    {DUSK}
    {FIRST_WATCH}

    [side]
        id=player1
        save_id=P1
        type=Elvish Captain
        side=1
        canrecruit=yes
        team_name= "Allies"
        user_team_name= _"Allies"
        controller="human"
        team_lock=true
        gold_lock=true
        income_lock=true
        gold=200
        share_maps="yes"
        share_view="yes"
        recruit=Elvish Fighter,Elvish Archer,Mage,Elvish Shaman,Elvish Scout,Merman Fighter,Merman Hunter,Mermaid Initiate
        shroud=yes
        fog=no
        village_gold=2
    [/side]
    [side]
        id=player2
        save_id=P2
        type=Dwarvish Steelclad
        side=2
        canrecruit=yes
        team_name= "Allies"
        user_team_name= _"Allies"
        controller="human"
        team_lock=true
        gold_lock=true
        income_lock=true
        share_maps="yes"
        share_view="yes"
        gold=200
        recruit=Dwarvish Guardsman,Dwarvish Fighter,Dwarvish Ulfserker,Dwarvish Thunderer,Mage,Merman Fighter,Merman Hunter,Mermaid Initiate
        shroud=yes
        fog=no
        village_gold=2
    [/side]
    [side]
        type=Fugitive
        side=3
        canrecruit=yes
        controller=ai
        allow_player="no"
        team_name= "Evils"
        user_team_name= _"Evils"
        gold=400
        income=10
        recruit=Bandit,Footpad,Rogue,Thief,Outlaw
        shroud=yes
        share_maps="yes"
        share_view="yes"
    [/side]
    [side]
        type=Highwayman
        side=4
        canrecruit=yes
        controller=ai
        allow_player="no"
        team_name= "Evils"
        user_team_name= _"Evils"
        gold=400
        income=10
        recruit=Bandit,Footpad,Rogue,Thief,Outlaw
        shroud=yes
        share_maps="yes"
        share_view="yes"
    [/side]
    [side]
        type=Troll Warrior
        side=5
        canrecruit=yes
        controller=ai
        allow_player="no"
        team_name= "Evils"
        user_team_name= _"Evils"
        income=40
        recruit=Troll Warrior, Troll
        gold=100
        share_maps="yes"
        share_view="yes"
        shroud=yes
        [ai]
            recruitment_pattern="fighter"
        [/ai]
    [/side]
    [side]
        type=Lich
        side=6
        canrecruit=yes
        id=unitid6
        role=frozen
        controller=ai
        allow_player="no"
        team_name= "Evils"
        user_team_name= _"Evils"
        income=10
        gold=100
        recruit=Skeleton,Skeleton Archer,Ghost,Wraith,Revenant,Bone Shooter,Deathblade
        shroud=yes
        share_maps="yes"
        share_view="yes"
    [/side]
    [side]
        type=Necromancer
        side=7
        canrecruit=yes
        id=unitid6
        role=frozen
        controller=ai
        allow_player="no"
        team_name= "Evils"
        user_team_name= _"Evils"
        income=10
        gold=100
        recruit=Skeleton,Skeleton Archer,Ghost,Wraith,Revenant,Bone Shooter,Deathblade
        shroud=yes
        share_maps="yes"
        share_view="yes"
    [/side]

    [side]
        no_leader=yes
        side=8
        team_name= "Evils"
        user_team_name= _"Evils"
        controller="ai"
        allow_player="no"
        fog=yes
        [ai]
            aggression=1.0
            caution=0.00
        [/ai]
    [/side]

#define GENERATE_HIDDEN_UNITS CNT
    {VARIABLE enemies 0}
    [while]
        [variable]
            name=enemies
            less_than={CNT}
        [/variable]
        [do]
            {VARIABLE_OP xloc random 1..60}
            {VARIABLE_OP yloc random 1..30}
            {VARIABLE_OP utyp random 1..3}
            [switch]
                variable=utyp
                [case]
                    value=1
                    {VARIABLE utype "Desert Cobra"}
                [/case]
                [case]
                    value=2
                    {VARIABLE utype "Desert Cobra"}
                [/case]
                [case]
                    value=3
                    {VARIABLE utype "Giant Scorpion"}
                [/case]
            [/switch]
            [store_unit]
                [filter]
                    x=$xloc
                    y=$yloc
                [/filter]
                variable=my_unit
            [/store_unit]
            [store_locations]
                x=$xloc
                y=$yloc
                variable=my_loc
                terrain=Dd,Ds,Hd
            [/store_locations]
            {IF_VAR my_loc.length numerical_not_equals 0 (
                [then]
                    {IF_VAR my_unit.length numerical_equals 0 (
                        [then]
                            [unit]
                                x,y=$xloc,$yloc
                                type=$utype
                                side=8
                                facing=sw
                                role=ambusher
                                random_traits=yes

                                [status]
                                    hidden=yes
                                [/status]
                            [/unit]

                            [object]
                                silent=yes
                                duration=level

                                [filter]
                                    x,y=$xloc,$yloc
                                [/filter]

                                [effect]
                                    apply_to=new_ability

                                    [abilities]
                                        [hides]
                                            id=desert_ambush
                                            affect_self=yes

                                            [filter_self]
                                                role=ambusher

                                                [filter_location]
                                                    terrain=Dd,Ds,Hd
                                                [/filter_location]
                                            [/filter_self]
                                        [/hides]
                                    [/abilities]
                                [/effect]
                            [/object]
                            {VARIABLE_OP enemies add 1}
                        [/then]
                    )}
                [/then]
            )}
        [/do]
    [/while]
    {CLEAR_VARIABLE enemies}
    {CLEAR_VARIABLE my_unit}
    {CLEAR_VARIABLE my_loc}
    {CLEAR_VARIABLE utyp}
    {CLEAR_VARIABLE utype}
    {CLEAR_VARIABLE xloc}
    {CLEAR_VARIABLE yloc}
#enddef

#define MAKE_FAST_IN_SAND UNIT_ID
    [store_unit]
        [filter]
            id={UNIT_ID}
        [/filter]
        variable=unitdesc
    [/store_unit]
    [object]
        id="fast_sand_{UNIT_ID}"
        [filter]
            id={UNIT_ID}
        [/filter]

        silent=yes
        [effect]
            apply_to=movement_costs
            replace=true
            [movement_costs]
                sand=$unitdesc.movement_costs.flat
            [/movement_costs]
        [/effect]
    [/object]
    {CLEAR_VARIABLE unitdesc}
#enddef

#define MAKE_FAST_IN_SAND_SIDE SIDE
    [store_unit]
        [filter]
            side={SIDE}
            canrecruit=yes
        [/filter]
        variable=leader_unit
    [/store_unit]
    {MAKE_FAST_IN_SAND "$leader_unit.id"}
    {CLEAR_VARIABLE leader_unit}

    [event]
        name=recruit
        first_time_only=no
        [filter]
            side={SIDE}
        [/filter]
        {MAKE_FAST_IN_SAND $unit.id}
    [/event]

    [event]
        name=recall
        first_time_only=no
        [filter]
            side={SIDE}
        [/filter]
        {MAKE_FAST_IN_SAND $unit.id}
    [/event]
#enddef

    [event]
        name=prestart

        [objectives]
            side=1
            [objective]
                description= _"Find the secret tunnel with either $Player1Name or $Player2Name."
                condition=win
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player1Name"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player2Name"
            [/objective]
            [objective]
                description= _"Turns run out"
                condition=lose
            [/objective]
        [/objectives]
        [objectives]
            side=2
            [objective]
                description= _"Find the secret tunnel with either $Player1Name or $Player2Name."
                condition=win
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player1Name"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player2Name"
            [/objective]
            [objective]
                description= _"Turns run out"
                condition=lose
            [/objective]
        [/objectives]

        {GENERATE_HIDDEN_UNITS 30}
        {MAKE_FAST_IN_SAND_SIDE 1}
        {MAKE_FAST_IN_SAND_SIDE 2}
        {MAKE_FAST_IN_SAND_SIDE 3}
        {MAKE_FAST_IN_SAND_SIDE 4}
        {MAKE_FAST_IN_SAND_SIDE 5}
        {MAKE_FAST_IN_SAND_SIDE 6}

        {PLACE_IMAGE "scenery/monolith1.png" 38 13}
        {PLACE_IMAGE "scenery/trapdoor-closed.png" 19 20}
        {MODIFY_UNIT side,type=6,Lich id unitid6}
        {MODIFY_UNIT id=unitid6 canrecruit no}
    [/event]

    [event]
        name=start

        [message]
            side=1
            message=_"We are very close now. There's a secret door somewhere here which enters the tunnel leading to our home!"
        [/message]

        [message]
            side=2
            message=_"As far as I remember, this door is in the middle of the desert. Let's find it, as I can hardly wait returning to our marvellous caves!"
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            side=1,2
            canrecruit=yes
        [/filter]
        [message]
            speaker=unit
            message=_"I die now, friends... I won't see my homeland any more..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=die
        first_time_only=no

        [filter]
            side=3,4,5
            canrecruit=yes
        [/filter]

        [store_unit]
            [filter]
                side=3,4,5
                canrecruit=yes
            [/filter]
            variable=enemy_leaders
        [/store_unit]

        {IF_VAR enemy_leaders.length numerical_equals 1 (
            [then]
                [message]
                    speaker=second_unit
                    message=_"I've found a magic ball at this guy. It might open the walls of the mountain..."
                [/message]
                {MODIFY_UNIT id=$second_unit.id hasBall "yes"}
                [unit_overlay]
                    x,y=$second_unit.x,$second_unit.y
                    image="misc/magic-ball.png"
                [/unit_overlay]
            [/then]
        )}
        {CLEAR_VARIABLE enemy_leaders}
    [/event]

    [event]
        name=time over
        [message]
            canrecruit=yes
            side=1
            message=_"Oh, no! We have run out of time, didn't manage to leave this desert..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=ai turn
        first_time_only=no

        {MODIFY_UNIT role=frozen moves 0}

        [if]
            [variable]
                name=side_number
                equals=8
            [/variable]

            [then]
                {MODIFY_UNIT side,role=8,ambusher moves 0}
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1,2

            [filter_adjacent]
                side=8
                role=ambusher
            [/filter_adjacent]
        [/filter]

        {MODIFY_UNIT (
            side=8
            role=ambusher

            [filter_adjacent]
                x,y=$x1,$y1
            [/filter_adjacent]
        ) role not_ambusher}

        {MODIFY_UNIT id=$unit.id status.hidden no}
        [redraw][/redraw]
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1,2
            x,y=38,13
        [/filter]

        {IF_VAR doorOpened not_equals "yes" (
            [then]
                {IF_VAR unit.hasBall not_equals "yes" (
                    [then]
                        [message]
                            speaker=narrator
                            message=_ "It's a magic monolith."
                            image=wesnoth-icon.png
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=unit
                            message=_ "I'll put the ball onto the monolith."
                        [/message]
                        [remove_unit_overlay]
                            x,y=$unit.x,$unit.y
                            image="misc/magic-ball.png"
                        [/remove_unit_overlay]
                        {QUAKE "rumble.ogg"}
                        {QUAKE "rumble.ogg"}
                        {QUAKE "rumble.ogg"}
                        {QUAKE "rumble.ogg"}
                        [redraw][/redraw]
                        [terrain]
                            x=35,36,37,37,37
                            y=13,13,14,15,16
                            terrain=Ds
                        [/terrain]
                        {VARIABLE doorOpened "yes"}
                        [message]
                            speaker=unit
                            message=_ "Sesame opened."
                        [/message]
                        [gold]
                            side=6
                            amount=300
                        [/gold]
                        {MODIFY_UNIT id=unitid6 role not_frozen}
                        {MODIFY_UNIT id=unitid6 canrecruit yes}
                        {CREATE_LOYAL_UNIT Lich 6 34 14}
                        {CREATE_LOYAL_UNIT Lich 6 35 16 }
                        {CREATE_LOYAL_UNIT Revenant 6 35 15 }
                        {CREATE_LOYAL_UNIT Deathblade 6 34 13 }
                        {CREATE_LOYAL_UNIT Deathblade 6 36 16 }
                        {CREATE_LOYAL_UNIT "Bone Shooter" 6 33 14 }
                        {CREATE_LOYAL_UNIT Revenant 6 34 15 }
                        {CREATE_LOYAL_UNIT "Bone Shooter" 6 35 17 }
                        {CREATE_LOYAL_UNIT "Bone Shooter" 6 26 12 }
                        {CREATE_LOYAL_UNIT Revenant 6 27 19 }
                        {CREATE_LOYAL_UNIT Deathblade 6 31 20 }
                        {CREATE_LOYAL_UNIT Deathblade 6 21 15 }

                        [store_unit]
                            [filter]
                                side=6
                            [/filter]
                            variable=evil_units
                        [/store_unit]

                        {FOREACH evil_units i}
                            {MAKE_FAST_IN_SAND $evil_units[$i].id}
                        {NEXT i}

                        {CLEAR_VARIABLE evil_units}
                    [/else]
                )}
            [/then]
        )}
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1,2
            x,y=19,20
        [/filter]

        {IF_VAR unit.canrecruit not_equals "yes" (
            [then]
                [message]
                    speaker=narrator
                    message=_ "Only a leader can open this door!"
                    image=wesnoth-icon.png
                [/message]
            [/then]
            [else]
                [endlevel]
                    bonus=yes
                    result=victory
                [/endlevel]
            [/else]
        )}
    [/event]

    [event]
        name=side turn
        first_time_only=no

        # thirsty units in the desert
        [store_unit]
            [filter]
                side=$side_number
                [and]
                    side=1,2
                [/and]
                [filter_location]
                    terrain=Dd,Ds,Hd
                    [not]
                        time_of_day=chaotic
                    [/not]
                [/filter_location]
            [/filter]
            variable=thirsty_units
        [/store_unit]

        {IF_VAR thirsty_units.length numerical_not_equals 0 (
            [then]
                {FOREACH thirsty_units i}
                    {VARIABLE thirsty_units[$i].resting no}
                    # unit's hitpoints drop by 4, but cannot kill it
                    {VARIABLE delta "$thirsty_units[$i].hitpoints"}
                    [if]
                        [have_unit]
                            x,y=$thirsty_units[$i].x,$thirsty_units[$i].y
                            [filter_adjacent]
                                is_enemy=no
                                side=$side_number
                                [and]
                                    ability=healing
                                    [or]
                                        ability=curing
                                    [/or]
                                [/and]
                            [/filter_adjacent]
                        [/have_unit]

                        [then]
                            {IF_VAR "thirsty_units[$i].status.poisoned" not_equals "yes" (
                                [then]
                                    {VARIABLE_OP "thirsty_units[$i].lost_water" add 8}
                                [/then]
                            )}
                            {VARIABLE "thirsty_units[$i].status.poisoned" "yes"}

                            [unstore_unit]
                                variable=thirsty_units[$i]
                            [/unstore_unit]
                        [/then]

                        [else]
                            [if]
                                [variable]
                                    name=thirsty_units[$i].hitpoints
                                    greater_than=4
                                [/variable]

                                [then]
                                    {VARIABLE_OP thirsty_units[$i].hitpoints add -4}
                                    {IF_VAR messageWritten not_equals "yes" (
                                        [then]
                                            [message]
                                                speaker=$thirsty_units[$i].id
                                                message = _"I'm thirsty! Without water we'll all lose our strength in this desert!"
                                            [/message]
                                            {VARIABLE messageWritten "yes"}
                                        [/then]
                                    )}
                                [/then]

                                [else]
                                    {VARIABLE thirsty_units[$i].hitpoints 1}
                                [/else]
                            [/if]
                            {VARIABLE_OP delta add -$thirsty_units[$i].hitpoints}
                            {VARIABLE_OP "thirsty_units[$i].lost_water" add $delta}

                            {IF_VAR "delta" numerical_not_equals 0 (
                                [then]
                                    [unstore_unit]
                                        variable=thirsty_units[$i]
                                        find_vacant=no
                                        text= "$delta"
                                        {COLOR_HARM}
                                    [/unstore_unit]
                                [/then]
                                [else]
                                    [unstore_unit]
                                        variable=thirsty_units[$i]
                                    [/unstore_unit]
                                [/else]
                            )}
                        [/else]
                    [/if]
                {NEXT i}
            [/then]
        )}

        {CLEAR_VARIABLE thirsty_units}

        # units in water/oasis can regain their strength they lost in the desert
        [store_unit]
            [filter]
                side=$side_number
                [and]
                    side=1,2
                    [not]
                        [filter_wml]
                            [status]
                                poisoned=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                [/and]
                [filter_location]
                    terrain=Ww,Dd^Do
                [/filter_location]
            [/filter]
            variable=units_in_water
        [/store_unit]

        {FOREACH units_in_water i}
            [if]
                [have_unit]
                    x,y=$units_in_water[$i].x,$units_in_water[$i].y
                    [filter_adjacent]
                        is_enemy=no
                        side=$side_number
                        [and]
                            ability=healing
                            [or]
                                ability=curing
                            [/or]
                        [/and]
                    [/filter_adjacent]
                [/have_unit]
                [then]
                    # don't do anything if we are next to a healing unit
                [/then]
                [else]
                    [store_locations]
                        x,y=$units_in_water[$i].x,$units_in_water[$i].y
                        variable=oasis
                        terrain=Dd^Do
                    [/store_locations]
                    {VARIABLE delta "$units_in_water[$i].lost_water"}
                    {VARIABLE canHeal "$units_in_water[$i].max_hitpoints"}
                    {VARIABLE_OP canHeal add "-$units_in_water[$i].hitpoints"}
                    {IF_VAR delta greater_than "$canHeal" (
                        [then]
                            {VARIABLE delta "$canHeal"}
                        [/then]
                    )}
                    {IF_VAR delta greater_than 8 (
                        [then]
                            {VARIABLE delta 8}
                        [/then]
                    )}
                    {IF_VAR delta greater_than 0 (
                        [then]
                            {VARIABLE_OP "units_in_water[$i].lost_water" add "-$delta"}
                            {IF_VAR oasis.length numerical_equals 0 (
                                [then]
                                    {IF_VAR units_in_water[$i].resting equals "yes" (
                                        [then]
                                            {VARIABLE units_in_water[$i].resting no}
                                            {VARIABLE_OP delta add 2}
                                        [/then]
                                    )}
                                    {VARIABLE_OP "units_in_water[$i].hitpoints" add "$delta"}
                                    [unstore_unit]
                                        variable=units_in_water[$i]
                                        find_vacant=no
                                        text= "$delta"
                                        {COLOR_HEAL}
                                    [/unstore_unit]
                                [/then]
                                [else]
                                    [unstore_unit]
                                        variable=units_in_water[$i]
                                    [/unstore_unit]
                                [/else]
                            )}
                        [/then]
                    )}
                [/else]
            [/if]
        {NEXT i}

        {CLEAR_VARIABLE units_in_water}

        {CLEAR_VARIABLE canHeal}
        {CLEAR_VARIABLE oasis}
        {CLEAR_VARIABLE delta}
    [/event]

    [event]
        name=victory

        {CLEAR_VARIABLE doorOpened}
        {CLEAR_VARIABLE messageWritten}
    [/event]

    [event]
        name=moveto
        first_time_only=yes

        [filter]
            side=1,2
            x=38-61
            y= 1-31
        [/filter]

        [gold]
            side=5
            amount=300
        [/gold]
    [/event]
[/multiplayer]
