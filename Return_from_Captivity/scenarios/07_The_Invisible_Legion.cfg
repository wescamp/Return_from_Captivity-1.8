#textdomain wesnoth-Return_from_Captivity

[multiplayer]
    id=CSABI_The_Invisible_Legion
    next_scenario=CSABI_The_Labyrinth
    name= _"RfC-The Invisible Legion"
    map_data="{~add-ons/Return_from_Captivity/maps/07_The_Invisible_Legion.map}"
    description= _"A multi player campaign for 2 cooperative players. Bring home the elves and dwarfs from the troll prison."
    turns="100"
    victory_when_enemies_defeated=no
    experience_modifier=100%
    allow_new_game=no
    {UNDERGROUND}
    {DEFAULT_MUSIC_PLAYLIST}

#define ABILITY_INVISIBILITY
    # Canned definition of the Invisiblility ability to be included in an
    # [abilities] clause.
    [hides]
        id=invisibility
        name= _"invisibility"
        name_inactive= _"invisibility"
        description= _"Invisibility:
This unit is invisible by its enemies.

Enemy units cannot see this unit, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        description_inactive= _"Invisibility:
This unit is invisible by its enemies.

Enemy units cannot see this unit, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        affect_self=yes
    [/hides]
#enddef

#define SET_INVISIBLE UNIT_ID
    [object]
        id="invisible_recruit_{UNIT_ID}"
        silent=yes
        [filter]
            id={UNIT_ID}
        [/filter]
        [effect]
            apply_to=new_ability
            [abilities]
                {ABILITY_INVISIBILITY}
            [/abilities]
        [/effect]
    [/object]
#enddef

#define CALCULATE_DISTANCE P_ID
    {IF_VAR pearl_taken_{P_ID} numerical_equals 1 (
        [then]
            [store_unit]
                variable=pearlUnit
                [filter]
                    id=$pearl_unit_id_{P_ID}
                [/filter]
            [/store_unit]
            {VARIABLE result 0}
            {VARIABLE rads 1}
            [while]
                [variable]
                    name=rads
                    less_than=9
                [/variable]
                [do]
                    [store_locations]
                        [filter]
                            side=3,4,5,6,7,8
                            [not]
                                id=$dyingUnit
                            [/not]
                        [/filter]
                        [and]
                            x,y=$pearlUnit.x,$pearlUnit.y
                            radius=$rads
                            [filter_radius]
                                terrain=!,Xu
                            [/filter_radius]
                        [/and]
                        [not]
                            terrain=Xu
                        [/not]
                        variable=detector
                    [/store_locations]
                    {IF_VAR detector.length numerical_not_equals 0 (
                        [then]
                            {VARIABLE result $rads}
                            {VARIABLE rads 10}
                        [/then]
                    )}
                    {VARIABLE_OP rads add 1}
                [/do]
            [/while]
            {CLEAR_VARIABLE rads}
            {CLEAR_VARIABLE detector}
            [remove_unit_overlay]
                x,y=$pearlUnit.x,$pearlUnit.y
                image="$pearl_last_image_{P_ID}"
            [/remove_unit_overlay]
            [unit_overlay]
                x,y=$pearlUnit.x,$pearlUnit.y
                image="misc/pearl-$result|.png"
            [/unit_overlay]
            {VARIABLE pearl_last_image_{P_ID} "misc/pearl-$result|.png"}
            {CLEAR_VARIABLE pearlUnit}
            {CLEAR_VARIABLE result}
        [/then]
    )}
#enddef

#define REMOVE_PEARL P_ID
    {IF_VAR pearl_taken_{P_ID} numerical_equals 1 (
        [then]
            [store_unit]
                variable=pearlUnit
                [filter]
                    id=$pearl_unit_id_{P_ID}
                [/filter]
            [/store_unit]
            [remove_unit_overlay]
                x,y=$pearlUnit.x,$pearlUnit.y
                image="$pearl_last_image_{P_ID}"
            [/remove_unit_overlay]
        [/then]
    )}
    {CLEAR_VARIABLE pearl_taken_{P_ID} }
    {CLEAR_VARIABLE pearl_unit_id_{P_ID} }
    {CLEAR_VARIABLE pearl_last_image_{P_ID} }
    {CLEAR_VARIABLE pearlUnit}
#enddef

#define PLACE_PEARL P_ID P_X P_Y
    {PLACE_IMAGE "misc/pearl.png" {P_X} {P_Y}}
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1,2
            x = {P_X}
            y = {P_Y}
        [/filter]
        [if]
            [variable]
                name="pearl_taken_{P_ID}"
                numerical_equals=0
            [/variable]
            [and]
                [variable]
                    name=pearl_unit_id_1
                    not_equals="$unit.id"
                [/variable]
            [/and]
            [and]
                [variable]
                    name=pearl_unit_id_2
                    not_equals="$unit.id"
                [/variable]
            [/and]
            [and]
                [variable]
                    name=pearl_unit_id_3
                    not_equals="$unit.id"
                [/variable]
            [/and]
            [and]
                [variable]
                    name=pearl_unit_id_4
                    not_equals="$unit.id"
                [/variable]
            [/and]
            [then]
                [message]
                    speaker=narrator
                    image="wesnoth-icon.png"
                    message= _"Do you want this unit to pick up the pearl?"
                    [option]
                        message= _"Yes"
                        [command]
                            {VARIABLE pearl_taken_{P_ID} 1}
                            {VARIABLE pearl_unit_id_{P_ID} "$unit.id"}
                            [removeitem]
                                x = {P_X}
                                y = {P_Y}
                            [/removeitem]
                            {CALCULATE_DISTANCE {P_ID} }
                        [/command]
                    [/option]
                    [option]
                        message= _"No"
                    [/option]
                [/message]
            [/then]
        [/if]
    [/event]
#enddef

    [time_area]
        x= 0- 4, 1- 3, 2, 5- 6, 7- 8, 9-10,11-12
        y=35-41,   34,33,37-41,38-41,39-41,40-41
        {DEFAULT_SCHEDULE}
    [/time_area]

    [side]
        id=player1
        save_id=P1
        type=Elvish Captain
        side=1
        canrecruit=yes
        team_name= "Allies"
        user_team_name= _"Allies"
        controller="human"
        team_lock=true
        gold_lock=true
        income_lock=true
        gold=200
        share_maps="yes"
        share_view="yes"
        recruit=Elvish Fighter,Elvish Archer,Mage,Elvish Shaman,Elvish Scout,Merman Fighter,Merman Hunter,Mermaid Initiate
        shroud=yes
        village_gold=2
    [/side]
    [side]
        id=player2
        save_id=P2
        type=Dwarvish Steelclad
        side=2
        canrecruit=yes
        team_name= "Allies"
        user_team_name= _"Allies"
        controller="human"
        team_lock=true
        gold_lock=true
        income_lock=true
        share_maps="yes"
        share_view="yes"
        gold=200
        recruit=Dwarvish Guardsman,Dwarvish Fighter,Dwarvish Ulfserker,Dwarvish Thunderer,Mage,Merman Fighter,Merman Hunter,Mermaid Initiate
        shroud=yes
        village_gold=2
    [/side]
    [side]
        id="side3-evil"
        type=Lich
        side=3
        canrecruit=yes
        team_name= "Evils"
        user_team_name= _"Evils"
        controller="ai"
        allow_player="no"
        gold=400
        recruit=Skeleton,Skeleton Archer,Vampire Bat,Ghost,Blood Bat,Wraith,Revenant,Bone Shooter,Deathblade
        shroud=yes
        [ai]
            recruitment_pattern="fighter,fighter,archer,archer,scout"
        [/ai]
        [modifications]
            {ABILITY_INVISIBILITY}
        [/modifications]
    [/side]
    [side]
        id="side4-evil"
        type=Lich
        side=4
        canrecruit=yes
        team_name= "Evils"
        user_team_name= _"Evils"
        controller="ai"
        allow_player="no"
        gold=400
        recruit=Skeleton,Skeleton Archer,Vampire Bat,Ghost,Blood Bat,Wraith,Revenant,Bone Shooter,Deathblade
        shroud=yes
        [ai]
            recruitment_pattern="fighter,fighter,archer,archer,scout"
        [/ai]
        [modifications]
            {ABILITY_INVISIBILITY}
        [/modifications]
    [/side]
    [side]
        id="side5-evil"
        type=Lich
        side=5
        canrecruit=yes
        team_name= "Evils"
        user_team_name= _"Evils"
        controller="ai"
        allow_player="no"
        gold=400
        recruit=Skeleton,Skeleton Archer,Vampire Bat,Ghost,Blood Bat,Wraith,Revenant,Bone Shooter,Deathblade
        shroud=yes
        [ai]
            recruitment_pattern="fighter,fighter,archer,archer,scout"
        [/ai]
        [modifications]
            {ABILITY_INVISIBILITY}
        [/modifications]
    [/side]

    [side]
        type=Great Troll
        gold=200
        canrecruit=yes
        side=6
        team_name= "Evils"
        user_team_name= _"Evils"
        controller="ai"
        allow_player="no"
        shroud=yes
        recruit=Troll, Troll Whelp
        income=20
        [ai]
            recruitment_pattern=fighter
        [/ai]
    [/side]

    [side]
        type=Great Troll
        gold=200
        canrecruit=yes
        side=7
        team_name= "Evils"
        user_team_name= _"Evils"
        controller="ai"
        allow_player="no"
        shroud=yes
        recruit=Troll, Troll Whelp
        income=20
        [ai]
            recruitment_pattern=fighter
        [/ai]
    [/side]

    [side]
        type=Naga Myrmidon
        gold=250
        canrecruit=yes
        side=8
        team_name= "Evils"
        user_team_name= _"Evils"
        controller="ai"
        allow_player="no"
        recruit=Vampire Bat, Naga Fighter, Naga Warrior
        shroud=yes
        income=15
        [ai]
            recruitment_pattern=scout, fighter, fighter
        [/ai]
    [/side]

    [event]
        name=prestart

        [store_unit]
            variable=evilUnit
            [filter]
                side=3
                canrecruit="yes"
            [/filter]
        [/store_unit]
        {SET_INVISIBLE $evilUnit[0].id}
        [store_unit]
            variable=evilUnit
            [filter]
                side=4
                canrecruit="yes"
            [/filter]
        [/store_unit]
        {SET_INVISIBLE $evilUnit[0].id}
        [store_unit]
            variable=evilUnit
            [filter]
                side=5
                canrecruit="yes"
            [/filter]
        [/store_unit]
        {SET_INVISIBLE $evilUnit[0].id}
        {CLEAR_VARIABLE evilUnit}

        {PLACE_IMAGE "scenery/signpost.png" 10 36}
        {PLACE_PEARL 1 7 34}
        {PLACE_PEARL 2 8 34}
        {PLACE_PEARL 3 14 36}
        {PLACE_PEARL 4 12 36}

        {PLACE_IMAGE items/chest.png 3 4}
        {PLACE_IMAGE items/chest.png 47 40}

        {CREATE_GUARD "Troll" 6 3 2}
        {CREATE_GUARD "Troll Hero" 6 4 3}
        {CREATE_GUARD Troll 7 48 38}
        {CREATE_GUARD "Troll Shaman" 7 49 40}

        {CREATE_GUARD "Tentacle of the Deep" 8 8 2}
        {CREATE_GUARD "Tentacle of the Deep" 8 10 5}
        {CREATE_GUARD "Tentacle of the Deep" 8 12 9}
        {CREATE_GUARD "Tentacle of the Deep" 8 17 14}
        {CREATE_GUARD "Tentacle of the Deep" 8 50 35}
        {CREATE_GUARD "Tentacle of the Deep" 8 45 31}
        {CREATE_GUARD "Tentacle of the Deep" 8 47 33}

        {CREATE_UNIT "Tentacle of the Deep" 8 22 18}
        {CREATE_UNIT "Tentacle of the Deep" 8 20 23}
        {CREATE_UNIT "Tentacle of the Deep" 8 23 21}
        {CREATE_UNIT "Tentacle of the Deep" 8 27 23}
        {CREATE_UNIT "Tentacle of the Deep" 8 30 24}
        {CREATE_UNIT "Tentacle of the Deep" 8 33 26}
        {CREATE_UNIT "Tentacle of the Deep" 8 35 24}
        {CREATE_UNIT "Tentacle of the Deep" 8 42 26}
        {CREATE_UNIT "Tentacle of the Deep" 8 33 22}
        {CREATE_UNIT "Tentacle of the Deep" 8 40 23}

        {CREATE_GUARD "Giant Scorpion" 6 24 27}
        {CREATE_GUARD "Giant Scorpion" 6 25 29}
        {CREATE_GUARD "Giant Ant" 7 21 34}
        {CREATE_GUARD "Giant Ant" 7 21 37}
        {CREATE_GUARD "Giant Scorpion" 7 47 29}
        {CREATE_GUARD "Giant Ant" 7 45 35}
        {CREATE_GUARD "Giant Ant" 7 41 35}
        {CREATE_GUARD "Giant Scorpion" 6 15 26}
        {CREATE_GUARD "Giant Scorpion" 6 9 22}
        {CREATE_GUARD "Giant Ant" 6 5 11}
        {CREATE_GUARD "Giant Ant" 6 4 16}
        {CREATE_GUARD "Giant Spider" 6 21 11}
        {CREATE_GUARD "Giant Spider" 6 23 11}
        {CREATE_GUARD "Giant Spider" 6 23 3}
        {CREATE_GUARD "Giant Spider" 6 30 2}
        {CREATE_GUARD "Giant Spider" 7 28 12}
        {CREATE_GUARD "Giant Spider" 7 46 25}
        {CREATE_GUARD "Giant Spider" 7 48 18}
        {CREATE_GUARD "Giant Spider" 7 49 12}

        [objectives]
            side=1
            [objective]
                description= _"Kill every invisible unit."
                condition=win
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player1Name"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player2Name"
            [/objective]
            [objective]
                description= _"Turns run out"
                condition=lose
            [/objective]
        [/objectives]
        [objectives]
            side=2
            [objective]
                description= _"Kill every invisible unit."
                condition=win
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player1Name"
            [/objective]
            [objective]
                condition=lose
                description=_ "Death of $Player2Name"
            [/objective]
            [objective]
                description= _"Turns run out"
                condition=lose
            [/objective]
        [/objectives]
        [remove_shroud]
            x= 0- 3, 2, 0-12, 0-11,13-14,44-51,41-43,43,47-51,49,51,45-46
            y=34-41,33,40-41,38-39,   41, 0- 3, 0- 1, 2, 4- 5, 6, 6,    4
        [/remove_shroud]
    [/event]

    [event]
        name=start

        [move_unit_fake]
            type=Dwarvish Guardsman
            side=2
            x=16,15,14,13,12,11
            y=35,35,34,35,35,35
        [/move_unit_fake]

        [unit]
            type=Dwarvish Guardsman
            x=10
            y=35
            side=2
            id=side2_messager
            random_traits=yes
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]

        [message]
            speaker=side2_messager
            message= _"Please don't enter into this cave! It's extremely dangerous, full of trolls, nagas, insects and enchanted invisible undeads."
        [/message]
        [message]
            side=2
            canrecruit=yes
            message= _"We have to cross this cave, we don't have time to travel 100 miles more for by-passing."
        [/message]
        [message]
            speaker=side2_messager
            image="misc/pearldesc.png"
            message= _"Then use the magic pearls please. The pearls help you detect the enemy from distance. If the colour of the pearl is green, then there's no enemy nearby. If the pearl is red, then the enemy is adjacent to you. The image shows the colour of the pearl and the distance of the enemy.
Finding the invisible undeads is much easier if you use the pearls."
        [/message]
        [message]
            side=2
            canrecruit=yes
            message= _"Thanks, the pearls will be great help to us."
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            side=1,2
            canrecruit=yes
        [/filter]
        [message]
            speaker=unit
            message=_"I die now, friends... I won't see my homeland any more..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            side=3,4,5
        [/filter]
        [store_unit]
            [filter]
                side=3,4,5
                [not]
                    id=$unit.id
                [/not]
            [/filter]
            variable=enemyUnits
        [/store_unit]
        {IF_VAR enemyUnits.length numerical_equals 0 (
            [then]
                {CLEAR_VARIABLE enemyUnits }
                [endlevel]
                    bonus=yes
                    result=victory
                [/endlevel]
            [/then]
        )}
        {CLEAR_VARIABLE enemyUnits }
    [/event]

    [event]
        name=die
        first_time_only=no

        [filter]
            side=3,4,5,6,7,8
        [/filter]

        {VARIABLE i 1}
        {VARIABLE dyingUnit $unit.id}
        [while]
            [variable]
                name=i
                less_than=5
            [/variable]
            [do]
                {CALCULATE_DISTANCE $i}
                {VARIABLE_OP i add 1}
            [/do]
        [/while]
        {CLEAR_VARIABLE i }
        {CLEAR_VARIABLE dyingUnit }
    [/event]

    [event]
        name=time over
        [message]
            canrecruit=yes
            side=1
            message=_"Oh, no! We have run out of time, didn't manage to get out of the cave..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=prerecruit
        first_time_only=no

        [filter]
            side=3,4,5
        [/filter]
        {SET_INVISIBLE $unit.id}
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=$pearl_unit_id_1
        [/filter]
        {CALCULATE_DISTANCE 1}
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=$pearl_unit_id_2
        [/filter]
        {CALCULATE_DISTANCE 2}
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=$pearl_unit_id_3
        [/filter]
        {CALCULATE_DISTANCE 3}
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=$pearl_unit_id_4
        [/filter]
        {CALCULATE_DISTANCE 4}
    [/event]

    [event]
        name=new turn
        first_time_only=no

        {VARIABLE i 1}
        [while]
            [variable]
                name=i
                less_than=5
            [/variable]
            [do]
                {CALCULATE_DISTANCE $i}
                {VARIABLE_OP i add 1}
            [/do]
        [/while]
        {CLEAR_VARIABLE i }
        [store_unit]
            [filter]
                side=3,4,5
            [/filter]
            variable=enemyUnits
        [/store_unit]
        [print]
            text = _"$enemyUnits.length invisible unit(s) to kill"
            size = 25
            red = 255
        [/print]
        {CLEAR_VARIABLE enemyUnits }
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1,2
            x= 10
            y= 36
        [/filter]
        [message]
            speaker=narrator
            message=_"Be careful, there are invisible undeads in this cave."
            image=wesnoth-icon.png
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1,2
            [filter_location]
                terrain=Chw,Ww,Wo,Ww^Vm,Wwf
            [/filter_location]
        [/filter]
        {CREATE_UNIT "Cuttle Fish" 8 23 21}
        {CREATE_UNIT "Cuttle Fish" 8 35 24}
        {CREATE_UNIT "Sea Serpent" 8 28 22}
        [gold]
            amount=400
            side=8
        [/gold]
    [/event]

    [event]
        name=moveto
        [filter]
            x=3
            y=4
            side=1,2
        [/filter]
        [sound]
            name=gold.ogg
        [/sound]
        [message]
            speaker=unit
            message= _"There is a great fortune in this chest of treasure! I can count 1000 pieces of gold!"
        [/message]
        [gold]
            side=$unit.side
            amount=1000
        [/gold]
        [removeitem]
            x,y=3,4
        [/removeitem]
    [/event]

    [event]
        name=moveto
        [filter]
            x=47
            y=40
            side=1,2
        [/filter]
        [sound]
            name=gold.ogg
        [/sound]
        [message]
            speaker=unit
            message= _"There is a great fortune in this chest of treasure! I can count 1000 pieces of gold!"
        [/message]
        [gold]
            side=$unit.side
            amount=1000
        [/gold]
        [removeitem]
            x,y=47,40
        [/removeitem]
    [/event]

    [event]
        name=victory

        {VARIABLE i 1}
        [while]
            [variable]
                name=i
                less_than=5
            [/variable]
            [do]
                {REMOVE_PEARL $i}
                {VARIABLE_OP i add 1}
            [/do]
        [/while]
        {CLEAR_VARIABLE i }
    [/event]

    [event]
        name=moveto
        [filter]
            side=1,2
            [filter_location]
                x,y=7,28
                radius=9
                [filter_radius]
                    terrain=!,Xu,Qxu
                [/filter_radius]
            [/filter_location]
        [/filter]
        {INCREASE_GOLD 4 200}
    [/event]

    [event]
        name=moveto
        [filter]
            side=1,2
            [filter_location]
                x,y=38,37
                radius=7
                [filter_radius]
                    terrain=!,Xu,Qxu
                [/filter_radius]
            [/filter_location]
        [/filter]
        {INCREASE_GOLD 3 200}
    [/event]

    [event]
        name=moveto
        [filter]
            side=1,2
            [filter_location]
                x,y=42,7
                radius=23
                [filter_radius]
                    terrain=!,Xu,Qxu
                [/filter_radius]
            [/filter_location]
        [/filter]
        {INCREASE_GOLD 5 400}
    [/event]
[/multiplayer]
